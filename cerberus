#!/usr/bin/env bash

### BEGIN INIT INFO
# Provides:          cerberus
# Required-Start:
# Required-Stop:
# Should-Start:
# Default-Start:
# Default-Stop:
# Short-Description: Transparent Proxy through TOR.
### END INIT INFO

# Cerberus v2.1.1 - Enhanced with Advanced Tor Service Diagnostics
# Engineered by 0xb0rn3 | 0xbv1
# Repository: https://github.com/0xb0rn3/cerberus
# Enhanced with comprehensive Tor service debugging and repair

export BLUE='\033[1;94m'
export GREEN='\033[1;92m'
export RED='\033[1;91m'
export YELLOW='\033[1;93m'
export RESETCOLOR='\033[1;00m'

# Destinations you don't want routed through Tor
TOR_EXCLUDE="192.168.0.0/16 172.16.0.0/12 10.0.0.0/8"

# The UID Tor runs as
TOR_UID="tor"

# Tor's TransPort
TOR_PORT="9040"

# Cerberus directories
CERBERUS_DIR="/var/lib/cerberus"
CERBERUS_CACHE="$CERBERUS_DIR/cache"
CERBERUS_LOGS="/var/log/cerberus"

# Exit node lists
EXIT_NODES_FILE="$CERBERUS_CACHE/exit-nodes.txt"
ALL_NODES_FILE="$CERBERUS_CACHE/all-nodes.txt"
NODE_METADATA="$CERBERUS_CACHE/node-metadata.json"

# Enhanced diagnostic configuration
DIAGNOSTIC_LOG="$CERBERUS_LOGS/diagnostic.log"
TOR_SERVICE="tor.service"
TOR_UNIT_PATH="/usr/lib/systemd/system/tor.service"

# Check if systemd-resolved is active
if systemctl is-active --quiet systemd-resolved; then
    resolved_support=true
else
    resolved_support=false
fi

# Enhanced logging function
log_message() {
    local message="$1"
    local level="${2:-INFO}"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    # Log to cerberus log file
    echo "[$timestamp] [$level] $message" >> "$CERBERUS_LOGS/cerberus.log" 2>/dev/null
    
    # Display to console if interactive
    if [ -t 1 ]; then
        echo -e "$message"
    fi
}

# Advanced Tor service diagnostics
diagnose_tor_service() {
    local context="${1:-manual}"
    
    log_message "$BLUE=== Advanced Tor Service Diagnostics ===$RESETCOLOR"
    echo "[$$(date '+%Y-%m-%d %H:%M:%S')] Starting diagnostic for context: $context" >> "$DIAGNOSTIC_LOG"
    
    local issues_found=0
    local fixes_available=0
    
    # Check 1: Service unit file
    log_message "$BLUE Checking service unit file...$RESETCOLOR"
    if [ ! -f "$TOR_UNIT_PATH" ]; then
        log_message "$RED ✗ Tor unit file missing: $TOR_UNIT_PATH$RESETCOLOR"
        echo "ISSUE: Unit file missing" >> "$DIAGNOSTIC_LOG"
        ((issues_found++))
    else
        local file_size=$(stat -c%s "$TOR_UNIT_PATH" 2>/dev/null || echo "0")
        if [ "$file_size" -eq 0 ]; then
            log_message "$RED ✗ Tor unit file is corrupted (0 bytes)$RESETCOLOR"
            echo "ISSUE: Unit file corrupted (0 bytes)" >> "$DIAGNOSTIC_LOG"
            ((issues_found++))
            ((fixes_available++))
        else
            log_message "$GREEN ✓ Unit file exists and is not empty$RESETCOLOR"
        fi
    fi
    
    # Check 2: Service status
    log_message "$BLUE Checking service status...$RESETCOLOR"
    if systemctl is-failed --quiet tor.service; then
        log_message "$RED ✗ Tor service is in failed state$RESETCOLOR"
        ((issues_found++))
        
        # Get detailed failure reason
        local failure_reason=$(systemctl status tor.service 2>&1 | grep -E "(failed|error|exit|status)" | head -3)
        echo "FAILURE REASON: $failure_reason" >> "$DIAGNOSTIC_LOG"
        log_message "$YELLOW Failure details: $failure_reason$RESETCOLOR"
    elif systemctl is-active --quiet tor.service; then
        log_message "$GREEN ✓ Tor service is running$RESETCOLOR"
    else
        log_message "$YELLOW ⚠ Tor service is inactive$RESETCOLOR"
    fi
    
    # Check 3: Configuration file
    log_message "$BLUE Checking Tor configuration...$RESETCOLOR"
    if [ ! -f /etc/tor/torrc ]; then
        log_message "$RED ✗ Tor configuration file missing$RESETCOLOR"
        echo "ISSUE: torrc missing" >> "$DIAGNOSTIC_LOG"
        ((issues_found++))
        ((fixes_available++))
    else
        # Test configuration validity
        if sudo -u tor tor --verify-config -f /etc/tor/torrc &>/dev/null; then
            log_message "$GREEN ✓ Tor configuration is valid$RESETCOLOR"
        else
            log_message "$RED ✗ Tor configuration has errors$RESETCOLOR"
            echo "ISSUE: Invalid torrc configuration" >> "$DIAGNOSTIC_LOG"
            ((issues_found++))
            ((fixes_available++))
            
            # Get detailed error
            local config_error=$(sudo -u tor tor --verify-config -f /etc/tor/torrc 2>&1 | head -3)
            echo "CONFIG ERROR: $config_error" >> "$DIAGNOSTIC_LOG"
            log_message "$YELLOW Config error: $config_error$RESETCOLOR"
        fi
    fi
    
    # Check 4: User and permissions
    log_message "$BLUE Checking user and permissions...$RESETCOLOR"
    if ! id -u tor > /dev/null 2>&1; then
        log_message "$RED ✗ Tor user does not exist$RESETCOLOR"
        echo "ISSUE: Tor user missing" >> "$DIAGNOSTIC_LOG"
        ((issues_found++))
        ((fixes_available++))
    else
        log_message "$GREEN ✓ Tor user exists$RESETCOLOR"
        
        # Check directories
        local dirs_to_check=("/var/lib/tor" "/var/log/tor" "/run/tor")
        for dir in "${dirs_to_check[@]}"; do
            if [ ! -d "$dir" ]; then
                log_message "$YELLOW ⚠ Directory missing: $dir$RESETCOLOR"
                echo "ISSUE: Directory missing - $dir" >> "$DIAGNOSTIC_LOG"
                ((issues_found++))
                ((fixes_available++))
            else
                local owner=$(stat -c %U "$dir" 2>/dev/null)
                if [ "$owner" != "tor" ]; then
                    log_message "$YELLOW ⚠ Directory wrong owner: $dir (owner: $owner)$RESETCOLOR"
                    echo "ISSUE: Wrong ownership - $dir" >> "$DIAGNOSTIC_LOG"
                    ((issues_found++))
                    ((fixes_available++))
                else
                    log_message "$GREEN ✓ Directory OK: $dir$RESETCOLOR"
                fi
            fi
        done
    fi
    
    # Check 5: Network connectivity
    log_message "$BLUE Checking network connectivity...$RESETCOLOR"
    if timeout 5 ping -c1 1.1.1.1 &>/dev/null; then
        log_message "$GREEN ✓ Network connectivity OK$RESETCOLOR"
    else
        log_message "$YELLOW ⚠ Network connectivity issues$RESETCOLOR"
        echo "ISSUE: Network connectivity problem" >> "$DIAGNOSTIC_LOG"
        ((issues_found++))
    fi
    
    # Check 6: Port conflicts
    log_message "$BLUE Checking for port conflicts...$RESETCOLOR"
    local tor_ports=(9050 9051 9040 5354)
    for port in "${tor_ports[@]}"; do
        if ss -tlnp | grep ":$port " | grep -v tor > /dev/null; then
            local process=$(ss -tlnp | grep ":$port " | grep -v tor | awk '{print $NF}')
            log_message "$YELLOW ⚠ Port $port in use by: $process$RESETCOLOR"
            echo "ISSUE: Port conflict - $port used by $process" >> "$DIAGNOSTIC_LOG"
            ((issues_found++))
        fi
    done
    
    # Check 7: Recent journal errors
    log_message "$BLUE Checking recent journal errors...$RESETCOLOR"
    local recent_errors=$(journalctl -u tor.service --since "5 minutes ago" --no-pager -q 2>/dev/null | grep -E "(error|failed|fatal)" | wc -l)
    if [ $recent_errors -gt 0 ]; then
        log_message "$YELLOW ⚠ Found $recent_errors recent errors in journal$RESETCOLOR"
        echo "ISSUE: Recent journal errors ($recent_errors)" >> "$DIAGNOSTIC_LOG"
        
        # Show last few errors
        log_message "$BLUE Recent errors:$RESETCOLOR"
        journalctl -u tor.service --since "5 minutes ago" --no-pager -q 2>/dev/null | grep -E "(error|failed|fatal)" | tail -3 | while read line; do
            log_message "$YELLOW   $line$RESETCOLOR"
        done
    fi
    
    # Summary
    log_message "$BLUE=== Diagnostic Summary ===$RESETCOLOR"
    echo "SUMMARY: Issues found: $issues_found, Fixes available: $fixes_available" >> "$DIAGNOSTIC_LOG"
    
    if [ $issues_found -eq 0 ]; then
        log_message "$GREEN ✓ No issues detected with Tor service$RESETCOLOR"
        return 0
    else
        log_message "$YELLOW ⚠ Found $issues_found issues with Tor service$RESETCOLOR"
        if [ $fixes_available -gt 0 ]; then
            log_message "$BLUE ℹ $fixes_available issues can be automatically fixed$RESETCOLOR"
            return 1
        else
            log_message "$RED ✗ Issues require manual intervention$RESETCOLOR"
            return 2
        fi
    fi
}

# Advanced Tor service repair
repair_tor_service() {
    log_message "$GREEN=== Starting Tor Service Repair ===$RESETCOLOR"
    echo "[$$(date '+%Y-%m-%d %H:%M:%S')] Starting repair process" >> "$DIAGNOSTIC_LOG"
    
    local repairs_made=0
    
    # Stop any running tor processes
    log_message "$BLUE Stopping existing Tor processes...$RESETCOLOR"
    systemctl stop tor.service 2>/dev/null || true
    pkill -f tor 2>/dev/null || true
    sleep 2
    
    # Repair 1: Create/fix tor user
    if ! id -u tor > /dev/null 2>&1; then
        log_message "$BLUE Creating tor user...$RESETCOLOR"
        useradd -r -s /bin/false -d /var/lib/tor -c "Tor daemon user" tor
        ((repairs_made++))
    fi
    
    # Repair 2: Create and fix directories
    log_message "$BLUE Creating/fixing Tor directories...$RESETCOLOR"
    local dirs_to_fix=("/var/lib/tor" "/var/log/tor" "/run/tor" "/etc/tor")
    for dir in "${dirs_to_fix[@]}"; do
        if [ ! -d "$dir" ]; then
            mkdir -p "$dir"
            log_message "$GREEN ✓ Created directory: $dir$RESETCOLOR"
            ((repairs_made++))
        fi
        
        # Fix ownership
        if [ "$dir" != "/etc/tor" ]; then
            chown -R tor:tor "$dir" 2>/dev/null
            chmod 755 "$dir" 2>/dev/null
            if [ "$dir" = "/var/lib/tor" ]; then
                chmod 700 "$dir" 2>/dev/null
            fi
        fi
    done
    
    # Repair 3: Fix/create torrc
    if [ ! -f /etc/tor/torrc ] || ! sudo -u tor tor --verify-config -f /etc/tor/torrc &>/dev/null; then
        log_message "$BLUE Creating/fixing Tor configuration...$RESETCOLOR"
        
        # Backup existing config
        [ -f /etc/tor/torrc ] && cp /etc/tor/torrc /etc/tor/torrc.broken.$(date +%s)
        
        cat > /etc/tor/torrc << 'EOF'
# Cerberus Tor Configuration v2.1.1 - Enhanced
# Auto-generated configuration for maximum compatibility

# Basic network settings
VirtualAddrNetwork 10.192.0.0/10
AutomapHostsOnResolve 1
TransPort 9040
SocksPort 9050
DNSPort 5354
RunAsDaemon 1

# Essential paths and security
DataDirectory /var/lib/tor
PidFile /run/tor/tor.pid
AvoidDiskWrites 1

# Control port for management
ControlPort 9051
CookieAuthentication 1
CookieAuthFileGroupReadable 1
CookieAuthFile /run/tor/control.authcookie

# Performance settings (conservative)
CircuitBuildTimeout 15
ClientOnly 1
NewCircuitPeriod 30
MaxCircuitDirtiness 600

# Logging
Log notice file /var/log/tor/notices.log
Log warn file /var/log/tor/warnings.log

# Exit policy (client only)
ExitPolicy reject *:*

# Additional security
DisableDebuggerAttachment 1
EOF
        
        chown root:root /etc/tor/torrc
        chmod 644 /etc/tor/torrc
        ((repairs_made++))
        
        # Test new configuration
        if sudo -u tor tor --verify-config -f /etc/tor/torrc &>/dev/null; then
            log_message "$GREEN ✓ New Tor configuration is valid$RESETCOLOR"
        else
            log_message "$RED ✗ New configuration still has issues$RESETCOLOR"
            local config_error=$(sudo -u tor tor --verify-config -f /etc/tor/torrc 2>&1 | head -2)
            log_message "$YELLOW Error details: $config_error$RESETCOLOR"
        fi
    fi
    
    # Repair 4: Fix package issues
    if [ ! -f "$TOR_UNIT_PATH" ] || [ $(stat -c%s "$TOR_UNIT_PATH" 2>/dev/null || echo "0") -eq 0 ]; then
        log_message "$BLUE Repairing Tor package installation...$RESETCOLOR"
        
        # Reinstall tor package
        if pacman -S tor --overwrite "*" --noconfirm >/dev/null 2>&1; then
            log_message "$GREEN ✓ Tor package reinstalled successfully$RESETCOLOR"
            ((repairs_made++))
            
            # Handle .pacnew files
            if [ -f /etc/tor/torrc.pacnew ]; then
                log_message "$BLUE Handling configuration updates...$RESETCOLOR"
                # Keep our custom config but backup the new one
                mv /etc/tor/torrc.pacnew /etc/tor/torrc.dist
                log_message "$GREEN ✓ Saved distribution config as torrc.dist$RESETCOLOR"
            fi
        else
            log_message "$RED ✗ Failed to reinstall Tor package$RESETCOLOR"
        fi
    fi
    
    # Repair 5: Clear any service failure states
    log_message "$BLUE Resetting service state...$RESETCOLOR"
    systemctl daemon-reload
    systemctl reset-failed tor.service 2>/dev/null || true
    
    # Final test
    log_message "$BLUE Testing repaired Tor service...$RESETCOLOR"
    if systemctl start tor.service; then
        sleep 3
        if systemctl is-active --quiet tor.service; then
            log_message "$GREEN ✓ Tor service repair successful!$RESETCOLOR"
            echo "REPAIR SUCCESS: $repairs_made repairs made" >> "$DIAGNOSTIC_LOG"
            return 0
        else
            log_message "$RED ✗ Service still failing after repair$RESETCOLOR"
            echo "REPAIR PARTIAL: Service still failing" >> "$DIAGNOSTIC_LOG"
            return 1
        fi
    else
        log_message "$RED ✗ Failed to start Tor service after repair$RESETCOLOR"
        echo "REPAIR FAILED: Could not start service" >> "$DIAGNOSTIC_LOG"
        return 1
    fi
}

# Enhanced status check with diagnostics
status_with_diagnostics() {
    log_message "$BLUE=== Comprehensive Cerberus Status ===$RESETCOLOR"
    
    # Basic service status
    if systemctl is-active --quiet tor; then
        log_message "$GREEN ✓ Tor service is running$RESETCOLOR"
        
        # Test actual connectivity
        if timeout 5 curl -s --socks5-hostname 127.0.0.1:9050 https://check.torproject.org/ | grep -q "Congratulations"; then
            log_message "$GREEN ✓ Tor connectivity verified$RESETCOLOR"
        else
            log_message "$YELLOW ⚠ Tor service running but connectivity test failed$RESETCOLOR"
        fi
        
    else
        log_message "$RED ✗ Tor service is not running$RESETCOLOR"
        
        # Quick diagnostic
        if systemctl is-failed --quiet tor.service; then
            log_message "$RED ✗ Tor service is in failed state$RESETCOLOR"
            log_message "$BLUE Running quick diagnostic...$RESETCOLOR"
            diagnose_tor_service "status_check"
        fi
    fi
    
    # Cerberus tunnel status
    if iptables -t nat -L OUTPUT 2>/dev/null | grep -q "REDIRECT.*$TOR_PORT"; then
        log_message "$GREEN ✓ Cerberus tunnel is active$RESETCOLOR"
    else
        log_message "$RED ✗ Cerberus tunnel is not active$RESETCOLOR"
    fi
    
    # IPv6 status
    if [ -f /etc/sysctl.d/98-cerberus.conf ]; then
        log_message "$GREEN ✓ IPv6 is disabled$RESETCOLOR"
    else
        log_message "$BLUE ℹ IPv6 is enabled$RESETCOLOR"
    fi
    
    # Database status
    if [ -f "$EXIT_NODES_FILE" ]; then
        local nodes_count=$(wc -l < "$EXIT_NODES_FILE")
        local last_update=$(stat -c %y "$EXIT_NODES_FILE" | cut -d'.' -f1)
        log_message "$GREEN ✓ Exit nodes database: $nodes_count nodes (updated: $last_update)$RESETCOLOR"
    else
        log_message "$YELLOW ⚠ Exit nodes database not found$RESETCOLOR"
    fi
    
    echo ""
}

function setup_cerberus_directories {
    mkdir -p "$CERBERUS_DIR"
    mkdir -p "$CERBERUS_CACHE"
    mkdir -p "$CERBERUS_LOGS"
    chmod 755 "$CERBERUS_DIR"
    chmod 755 "$CERBERUS_CACHE"
    chmod 755 "$CERBERUS_LOGS"
}

function setup_tor_directories {
    mkdir -p /var/lib/tor
    mkdir -p /var/log/tor
    mkdir -p /run/tor
    
    chown -R tor:tor /var/lib/tor
    chown -R tor:tor /var/log/tor
    chown -R tor:tor /run/tor
    
    chmod 700 /var/lib/tor
    chmod 755 /var/log/tor
    chmod 755 /run/tor
}

function configure_tor {
    if [ -f /etc/tor/torrc ] && [ ! -f /etc/tor/torrc.backup ]; then
        cp /etc/tor/torrc /etc/tor/torrc.backup
    fi
    
    cat > /etc/tor/torrc << 'EOF'
# Cerberus Tor Configuration v2.1.1

# Network settings
VirtualAddrNetwork 10.192.0.0/10
AutomapHostsOnResolve 1
TransPort 9040 IsolateClientAddr IsolateSOCKSAuth IsolateClientProtocol IsolateDestPort IsolateDestAddr
SocksPort 9050 IsolateClientAddr IsolateSOCKSAuth IsolateClientProtocol IsolateDestPort IsolateDestAddr
DNSPort 5354
RunAsDaemon 1

# Security settings
AvoidDiskWrites 1
DataDirectory /var/lib/tor
PidFile /run/tor/tor.pid

# Control port for identity changes and monitoring
ControlPort 9051
CookieAuthentication 1
CookieAuthFileGroupReadable 1
CookieAuthFile /run/tor/control.authcookie

# Performance optimizations
CircuitBuildTimeout 10
LearnCircuitBuildTimeout 0
ClientOnly 1
NewCircuitPeriod 30
MaxCircuitDirtiness 600

# Connection settings
KeepAlivePeriod 60
ConnLimit 2048

# Logging
Log notice file /var/log/tor/notices.log

# Exit policy
ExitPolicy reject *:*
EOF
    
    chown root:root /etc/tor/torrc
    chmod 644 /etc/tor/torrc
}

function update_exit_nodes {
    echo -e "$BLUE Updating Tor exit node lists...$RESETCOLOR"
    
    setup_cerberus_directories
    
    local temp_file="/tmp/tor-exits-$$"
    local sources_updated=0
    
    # Source 1: Dan.me.uk (most reliable, 30-min updates)
    if timeout 10 curl -sSL "https://www.dan.me.uk/torlist/?exit" -o "$temp_file" 2>/dev/null; then
        grep -E '^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$' "$temp_file" > "$EXIT_NODES_FILE.tmp"
        if [ -s "$EXIT_NODES_FILE.tmp" ]; then
            mv "$EXIT_NODES_FILE.tmp" "$EXIT_NODES_FILE"
            echo -e "$GREEN ✓ Updated from dan.me.uk: $(wc -l < $EXIT_NODES_FILE) exit nodes$RESETCOLOR"
            ((sources_updated++))
        fi
    fi
    
    # Source 2: GitHub platformbuilds (hourly updates)
    if timeout 10 curl -sSL "https://raw.githubusercontent.com/platformbuilds/Tor-IP-Addresses/master/tor-exit-nodes.lst" -o "$temp_file" 2>/dev/null; then
        grep -E '^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$' "$temp_file" >> "$EXIT_NODES_FILE.tmp2"
        if [ -s "$EXIT_NODES_FILE.tmp2" ]; then
            cat "$EXIT_NODES_FILE" "$EXIT_NODES_FILE.tmp2" 2>/dev/null | sort -u > "$EXIT_NODES_FILE.new"
            mv "$EXIT_NODES_FILE.new" "$EXIT_NODES_FILE"
            rm -f "$EXIT_NODES_FILE.tmp2"
            echo -e "$GREEN ✓ Merged GitHub data: $(wc -l < $EXIT_NODES_FILE) total nodes$RESETCOLOR"
            ((sources_updated++))
        fi
    fi
    
    # Source 3: All Tor nodes for complete list
    if timeout 10 curl -sSL "https://www.dan.me.uk/torlist/" -o "$temp_file" 2>/dev/null; then
        grep -E '^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$' "$temp_file" > "$ALL_NODES_FILE"
        if [ -s "$ALL_NODES_FILE" ]; then
            echo -e "$GREEN ✓ Updated all nodes: $(wc -l < $ALL_NODES_FILE) total$RESETCOLOR"
        fi
    fi
    
    rm -f "$temp_file"
    
    if [ $sources_updated -eq 0 ]; then
        echo -e "$YELLOW ⚠ Could not update exit nodes. Using cached list if available.$RESETCOLOR"
        if [ ! -f "$EXIT_NODES_FILE" ] || [ ! -s "$EXIT_NODES_FILE" ]; then
            echo -e "$RED ✗ No cached exit nodes available. Network features limited.$RESETCOLOR"
            return 1
        fi
    fi
    
    # Create ipset for efficient lookup if available
    if command -v ipset > /dev/null 2>&1; then
        ipset create tor-exits hash:ip -exist 2>/dev/null || true
        ipset flush tor-exits 2>/dev/null || true
        
        while IFS= read -r ip; do
            ipset add tor-exits "$ip" -exist 2>/dev/null || true
        done < "$EXIT_NODES_FILE"
        
        echo -e "$GREEN ✓ Loaded $(ipset list tor-exits | grep -c '^[0-9]') IPs into ipset$RESETCOLOR"
    fi
    
    return 0
}

function verify_tor_exit {
    local ip="$1"
    
    # Reverse IP for DNS query
    local reversed=$(echo "$ip" | awk -F. '{print $4"."$3"."$2"."$1}')
    
    # Method 1: Dan.me.uk DNSBL (fastest, most reliable)
    if host -W 1 "${reversed}.torexit.dan.me.uk" 2>/dev/null | grep -q "127.0.0.100"; then
        return 0
    fi
    
    # Method 2: Official Tor Project DNSEL
    if host -W 1 "${reversed}.dnsel.torproject.org" 2>/dev/null | grep -q "127.0.0.2"; then
        return 0
    fi
    
    # Method 3: Local cache check
    if [ -f "$EXIT_NODES_FILE" ] && grep -q "^${ip}$" "$EXIT_NODES_FILE" 2>/dev/null; then
        return 0
    fi
    
    return 1
}

function get_tor_info {
    echo -e "\n$BLUE Tor Network Information:$RESETCOLOR\n"
    
    # Current exit node
    local current_ip=$(timeout 5 curl -sSL --socks5-hostname 127.0.0.1:9050 "https://api.ipify.org" 2>/dev/null)
    
    if [ -n "$current_ip" ]; then
        echo -e "$GREEN Current Exit Node:$RESETCOLOR $current_ip"
        
        # Verify it's actually a Tor exit
        if verify_tor_exit "$current_ip"; then
            echo -e "$GREEN ✓ Verified Tor exit node$RESETCOLOR"
        else
            echo -e "$YELLOW ⚠ Could not verify as Tor exit (may be new)$RESETCOLOR"
        fi
        
        # Get geolocation if possible
        local geo=$(timeout 5 curl -sSL "http://ip-api.com/json/$current_ip" 2>/dev/null | \
                   grep -oP '"country":"[^"]+"|"city":"[^"]+"|"isp":"[^"]+"|"as":"[^"]+"' | \
                   cut -d'"' -f4 | paste -sd", " -)
        
        if [ -n "$geo" ]; then
            echo -e "$BLUE Location/ISP:$RESETCOLOR $geo"
        fi
    else
        echo -e "$RED ✗ Could not determine current exit node$RESETCOLOR"
    fi
    
    # Circuit info from Tor control port
    if command -v nc > /dev/null 2>&1 || command -v netcat > /dev/null 2>&1; then
        local nc_cmd="nc"
        command -v nc > /dev/null 2>&1 || nc_cmd="netcat"
        
        echo -e "\n$BLUE Tor Circuits:$RESETCOLOR"
        echo -e "AUTHENTICATE\nGETINFO circuit-status\nQUIT" | $nc_cmd 127.0.0.1 9051 2>/dev/null | \
            grep -E "^[0-9]+ BUILT" | head -3 | while read line; do
                echo "  • $line"
            done
    fi
    
    # Statistics
    if [ -f "$EXIT_NODES_FILE" ]; then
        echo -e "\n$BLUE Statistics:$RESETCOLOR"
        echo -e "  • Known exit nodes: $(wc -l < $EXIT_NODES_FILE)"
        [ -f "$ALL_NODES_FILE" ] && echo -e "  • Total Tor nodes: $(wc -l < $ALL_NODES_FILE)"
        echo -e "  • Last update: $(stat -c %y $EXIT_NODES_FILE | cut -d' ' -f1,2)"
    fi
    
    echo ""
}

function monitor_tor {
    echo -e "\n$BLUE Starting Tor network monitor...$RESETCOLOR"
    echo -e "$YELLOW Press Ctrl+C to stop$RESETCOLOR\n"
    
    local nc_cmd="nc"
    command -v nc > /dev/null 2>&1 || nc_cmd="netcat"
    
    while true; do
        clear
        echo -e "$RED╔═══════════════════════════════════════════════════════════════════════════════╗"
        echo -e "$RED║                    $GREEN Cerberus v2.1.1 - Tor Network Monitor                    $RED║"
        echo -e "$RED╚═══════════════════════════════════════════════════════════════════════════════╝$RESETCOLOR\n"
        
        # Current status
        if systemctl is-active --quiet tor; then
            echo -e "$GREEN ✓ Tor service: ACTIVE$RESETCOLOR"
        else
            echo -e "$RED ✗ Tor service: INACTIVE$RESETCOLOR"
        fi
        
        # Current IP and verification
        local current_ip=$(timeout 3 curl -sSL --socks5-hostname 127.0.0.1:9050 "https://api.ipify.org" 2>/dev/null)
        if [ -n "$current_ip" ]; then
            echo -e "$GREEN ✓ Exit node IP:$RESETCOLOR $current_ip"
            
            if verify_tor_exit "$current_ip"; then
                echo -e "$GREEN ✓ Verification: Confirmed Tor exit$RESETCOLOR"
            else
                echo -e "$YELLOW ⚠ Verification: Unconfirmed$RESETCOLOR"
            fi
        else
            echo -e "$RED ✗ Cannot reach Tor network$RESETCOLOR"
        fi
        
        # Bandwidth usage (if control port is available)
        if command -v $nc_cmd > /dev/null 2>&1; then
            echo -e "\n$BLUE Bandwidth (last 5 seconds):$RESETCOLOR"
            timeout 1 echo -e "AUTHENTICATE\nGETINFO traffic/read\nGETINFO traffic/written\nQUIT" | \
                $nc_cmd 127.0.0.1 9051 2>/dev/null | grep -E "^250-" | sed 's/250-traffic\//  /'
        fi
        
        # Active circuits
        echo -e "\n$BLUE Active circuits:$RESETCOLOR"
        if command -v $nc_cmd > /dev/null 2>&1; then
            timeout 1 echo -e "AUTHENTICATE\nGETINFO circuit-status\nQUIT" | \
                $nc_cmd 127.0.0.1 9051 2>/dev/null | grep "BUILT" | wc -l | xargs echo "  •"
        fi
        
        sleep 5
    done
}

function init {
    echo -e -n " $GREEN*$BLUE killing dangerous applications$RESETCOLOR\n"
    killall -q chrome dropbox firefox chromium skype thunderbird transmission deluge pidgin telegram discord slack signal-desktop 2>/dev/null || true
    
    echo -e -n " $GREEN*$BLUE cleaning cache elements$RESETCOLOR\n"
    if command -v bleachbit > /dev/null; then
        bleachbit -c firefox.cache chromium.cache google_chrome.cache &> /dev/null || true
    fi
    
    find /tmp -name "*.tmp" -type f -delete 2>/dev/null || true
    find /var/tmp -name "*.tmp" -type f -delete 2>/dev/null || true
}

function disable_ipv6 {
    echo -e "\n$GREEN[$BLUE i$GREEN ]$BLUE Disabling IPv6 services:$RESETCOLOR\n"
    
    if [ -f /etc/sysctl.d/98-cerberus.conf ]; then
        rm /etc/sysctl.d/98-cerberus.conf
    fi
    
    cat << EOF >> /etc/sysctl.d/98-cerberus.conf
# Disable IPv6 - Cerberus v2.1.1
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv6.conf.lo.disable_ipv6 = 1

# Additional network hardening
net.ipv4.tcp_timestamps = 0
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1
EOF
    
    if ! sysctl -p /etc/sysctl.d/98-cerberus.conf > /dev/null 2>&1; then
        echo -e "$RED Error applying sysctl settings$RESETCOLOR"
        return 1
    fi
    
    echo -e "$GREEN IPv6 disabled and network hardened$RESETCOLOR"
    return 0
}

function enable_ipv6 {
    echo -e "\n$GREEN[$BLUE i$GREEN ]$BLUE Enabling IPv6 services:$RESETCOLOR\n"
    
    if [ -f /etc/sysctl.d/98-cerberus.conf ]; then
        rm -f /etc/sysctl.d/98-cerberus.conf
    fi
    
    if ! sysctl --system > /dev/null 2>&1; then
        echo -e "$RED Error reloading sysctl settings$RESETCOLOR"
        return 1
    fi
    
    systemctl reload NetworkManager > /dev/null 2>&1 || true
    systemctl restart systemd-resolved > /dev/null 2>&1 || true
    
    echo -e "$GREEN IPv6 enabled$RESETCOLOR"
    return 0
}

function ip {
    echo -e "\n$BLUE Checking IP addresses...$RESETCOLOR\n"
    
    # Real IP (without Tor)
    echo -e "$YELLOW Real IP (without Tor):$RESETCOLOR"
    local real_ip=$(timeout 5 curl -sSL "https://api.ipify.org" 2>/dev/null)
    if [ -n "$real_ip" ]; then
        echo "  $real_ip"
    else
        echo "  Unable to determine"
    fi
    
    # Tor IP
    echo -e "\n$GREEN Tor IP (current exit node):$RESETCOLOR"
    local tor_ip=$(timeout 5 curl -sSL --socks5-hostname 127.0.0.1:9050 "https://api.ipify.org" 2>/dev/null)
    if [ -n "$tor_ip" ]; then
        echo "  $tor_ip"
        
        if verify_tor_exit "$tor_ip"; then
            echo -e "  $GREEN✓ Verified Tor exit node$RESETCOLOR"
        else
            echo -e "  $YELLOW⚠ Unverified exit node$RESETCOLOR"
        fi
    else
        echo "  Unable to connect through Tor"
    fi
    
    # Check if properly anonymized
    if [ -n "$real_ip" ] && [ -n "$tor_ip" ] && [ "$real_ip" != "$tor_ip" ]; then
        echo -e "\n$GREEN ✓ Traffic is being anonymized$RESETCOLOR"
    elif [ "$real_ip" = "$tor_ip" ]; then
        echo -e "\n$RED ✗ WARNING: Traffic may not be properly anonymized!$RESETCOLOR"
    fi
    
    echo -e "\n----------------------------------------------------------------------"
}

function start {
    if [ $(id -u) -ne 0 ]; then
        echo -e -e "\n$GREEN[$RED!$GREEN] $RED This script must be run as root$RESETCOLOR\n" >&2
        exit 1
    fi
    
    if ! command -v tor > /dev/null; then
        echo -e "\n$GREEN[$RED!$GREEN]$RED Tor is not installed. Install with: pacman -S tor$RESETCOLOR\n" >&2
        exit 1
    fi
    
    setup_cerberus_directories
    setup_tor_directories
    configure_tor
    
    # Enhanced pre-start check with advanced diagnostics
    log_message "$BLUE Performing comprehensive pre-start diagnostics...$RESETCOLOR"
    local diag_result
    diagnose_tor_service "pre-start"
    diag_result=$?
    
    if [ $diag_result -eq 1 ]; then
        # Issues found that can be fixed
        echo -e "$YELLOW Issues detected with Tor service. Attempt automatic repair? (Y/n)$RESETCOLOR"
        read -r auto_repair
        if [[ ! "$auto_repair" =~ ^[Nn]$ ]]; then
            if repair_tor_service; then
                log_message "$GREEN ✓ Tor service repair completed successfully$RESETCOLOR"
            else
                echo -e "$RED ✗ Could not repair Tor service automatically$RESETCOLOR"
                echo -e "$BLUE Manual intervention required. Check logs at: $DIAGNOSTIC_LOG$RESETCOLOR"
                exit 1
            fi
        else
            echo -e "$YELLOW Proceeding without repair - service may fail to start$RESETCOLOR"
        fi
    elif [ $diag_result -eq 2 ]; then
        echo -e "$RED ✗ Critical issues detected that require manual intervention$RESETCOLOR"
        echo -e "$BLUE Check diagnostic logs at: $DIAGNOSTIC_LOG$RESETCOLOR"
        exit 1
    fi
    
    # Update exit nodes before starting
    update_exit_nodes
    
    disable_ipv6
    
    echo -e "\n$GREEN[$BLUE i$GREEN ]$BLUE Starting Cerberus anonymous mode:$RESETCOLOR\n"
    
    systemctl daemon-reload
    
    if ! systemctl is-active --quiet tor; then
        echo -e " $BLUE*$BLUE Starting Tor service$RESETCOLOR\n"
        systemctl reload NetworkManager > /dev/null 2>&1 || true
        
        # Enhanced start with comprehensive retry logic
        local start_attempts=0
        local max_attempts=3
        
        while [ $start_attempts -lt $max_attempts ]; do
            if systemctl start tor; then
                echo -e " $GREEN*$BLUE Tor service started successfully$RESETCOLOR\n"
                break
            else
                ((start_attempts++))
                echo -e " $RED*$BLUE Tor service failed to start (attempt $start_attempts/$max_attempts)$RESETCOLOR\n"
                
                if [ $start_attempts -lt $max_attempts ]; then
                    echo -e " $YELLOW*$BLUE Diagnosing and attempting repair...$RESETCOLOR\n"
                    
                    # Run diagnostic and repair
                    diagnose_tor_service "start-retry"
                    if repair_tor_service; then
                        echo -e " $GREEN*$BLUE Auto-repair successful, retrying start...$RESETCOLOR\n"
                        sleep 2
                        continue
                    else
                        echo -e " $RED*$BLUE Auto-repair failed$RESETCOLOR\n"
                    fi
                fi
                
                # Show logs on final failure
                if [ $start_attempts -eq $max_attempts ]; then
                    echo -e " $RED*$BLUE All start attempts failed. Recent journal logs:$RESETCOLOR\n"
                    journalctl -u tor.service --no-pager -n 10
                    echo -e "\n$BLUE Full diagnostic log available at: $DIAGNOSTIC_LOG$RESETCOLOR"
                    exit 1
                fi
            fi
        done
        
        sleep 5
        
        if ! pgrep -f tor > /dev/null; then
            echo -e " $RED*$BLUE Tor process not found, attempting final recovery...$RESETCOLOR\n"
            if repair_tor_service; then
                systemctl start tor
                sleep 3
            fi
            
            if ! pgrep -f tor > /dev/null; then
                echo -e " $RED*$BLUE Tor failed to start properly after all attempts$RESETCOLOR\n"
                exit 1
            fi
        fi
    fi
    
    if ! [ -f /etc/iptables/iptables.rules.bak ]; then
        mkdir -p /etc/iptables
        iptables-save > /etc/iptables/iptables.rules.bak
        echo -e " $GREEN*$BLUE Saved iptables rules$RESETCOLOR\n"
    fi
    
    # Flush existing rules
    iptables -F
    iptables -t nat -F
    iptables -t mangle -F
    iptables -X
    
    # Configure DNS
    if [ "$resolved_support" = true ]; then
        if [ ! -f /etc/systemd/resolved.conf.bak ]; then
            cp /etc/systemd/resolved.conf /etc/systemd/resolved.conf.bak
        fi
        cat > /etc/systemd/resolved.conf << 'EOF'
[Resolve]
DNS=127.0.0.1
FallbackDNS=209.222.18.222 209.222.18.218
DNSStubListener=no
DNSSEC=no
DNSOverTLS=no
EOF
        systemctl restart systemd-resolved
        ln -sf /run/systemd/resolve/resolv.conf /etc/resolv.conf
    else
        if [ ! -f /etc/resolv.conf.bak ]; then
            cp /etc/resolv.conf /etc/resolv.conf.bak
        fi
        cat > /etc/resolv.conf << 'EOF'
nameserver 127.0.0.1
nameserver 209.222.18.222
nameserver 209.222.18.218
EOF
    fi
    
    echo -e " $BLUE*$BLUE Waiting for Tor to establish circuits...$RESETCOLOR\n"
    sleep 3
    
    # Set iptables NAT rules with isolation
    iptables -t nat -A OUTPUT -m owner --uid-owner $TOR_UID -j RETURN
    iptables -t nat -A OUTPUT -p udp --dport 53 -j REDIRECT --to-ports 5354
    iptables -t nat -A OUTPUT -p tcp --dport 53 -j REDIRECT --to-ports 5354
    iptables -t nat -A OUTPUT -p udp --dport 123 -j REDIRECT --to-ports 123
    
    # Resolve .onion domains
    iptables -t nat -A OUTPUT -p tcp -d 10.192.0.0/10 -j REDIRECT --to-ports 9040
    iptables -t nat -A OUTPUT -p udp -d 10.192.0.0/10 -j REDIRECT --to-ports 9040
    
    # Exclude local addresses
    for NET in $TOR_EXCLUDE 127.0.0.0/9 127.128.0.0/10; do
        iptables -t nat -A OUTPUT -d $NET -j RETURN
        iptables -A OUTPUT -d $NET -j ACCEPT
    done
    
    # Redirect all other output through TOR
    iptables -t nat -A OUTPUT -p tcp --syn -j REDIRECT --to-ports $TOR_PORT
    iptables -t nat -A OUTPUT -p udp -j REDIRECT --to-ports $TOR_PORT
    iptables -t nat -A OUTPUT -p icmp -j REDIRECT --to-ports $TOR_PORT
    
    # Accept already established connections
    iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
    
    # Allow only tor output
    iptables -A OUTPUT -m owner --uid-owner $TOR_UID -j ACCEPT
    iptables -A OUTPUT -j REJECT
    
    # Block IPv6 traffic
    ip6tables -P INPUT DROP 2>/dev/null || true
    ip6tables -P OUTPUT DROP 2>/dev/null || true
    ip6tables -P FORWARD DROP 2>/dev/null || true
    
    echo -e "$GREEN *$BLUE All traffic redirected through Tor$RESETCOLOR\n"
    echo -e "$GREEN[$BLUE i$GREEN ]$BLUE Cerberus tunnel active$RESETCOLOR\n"
    echo -e "$GREEN[$BLUE i$GREEN ]$BLUE Verifying connection...$RESETCOLOR\n"
    
    sleep 2
    if timeout 10 curl -s --socks5-hostname 127.0.0.1:9050 https://check.torproject.org/ | grep -q "Congratulations"; then
        echo -e "$GREEN[$BLUE i$GREEN ]$BLUE Tor connection verified successfully$RESETCOLOR\n"
        
        # Show current exit node info
        get_tor_info
    else
        echo -e "$RED[$BLUE !$RED ]$BLUE Warning: Unable to verify Tor connection$RESETCOLOR\n"
        echo -e "$BLUE Running post-start diagnostic...$RESETCOLOR"
        diagnose_tor_service "post-start"
    fi
}

function stop {
    if [ $(id -u) -ne 0 ]; then
        echo -e "\n$GREEN[$RED!$GREEN] $RED This script must be run as root$RESETCOLOR\n" >&2
        exit 1
    fi
    
    echo -e "\n$GREEN[$BLUE i$GREEN ]$BLUE Stopping Cerberus anonymous mode:$RESETCOLOR\n"
    
    iptables -F
    iptables -t nat -F
    iptables -t mangle -F
    iptables -X
    
    ip6tables -P INPUT ACCEPT 2>/dev/null || true
    ip6tables -P OUTPUT ACCEPT 2>/dev/null || true
    ip6tables -P FORWARD ACCEPT 2>/dev/null || true
    
    echo -e " $GREEN*$BLUE Cleared iptables rules$RESETCOLOR\n"
    
    if [ -f /etc/iptables/iptables.rules.bak ]; then
        iptables-restore < /etc/iptables/iptables.rules.bak
        rm /etc/iptables/iptables.rules.bak
        echo -e " $GREEN*$BLUE Restored iptables rules$RESETCOLOR"
    fi
    
    if [ "$resolved_support" = true ]; then
        if [ -e /etc/systemd/resolved.conf.bak ]; then
            mv /etc/systemd/resolved.conf.bak /etc/systemd/resolved.conf
            systemctl restart systemd-resolved
        fi
    else
        if [ -e /etc/resolv.conf.bak ]; then
            mv /etc/resolv.conf.bak /etc/resolv.conf
        fi
    fi
    
    systemctl stop tor 2>/dev/null || true
    pkill -f tor 2>/dev/null || true
    
    # Clear ipset if used
    if command -v ipset > /dev/null 2>&1; then
        ipset destroy tor-exits 2>/dev/null || true
    fi
    
    enable_ipv6
    
    echo -e " $GREEN*$BLUE Cerberus stopped$RESETCOLOR\n"
}

function change {
    if systemctl is-active --quiet tor; then
        echo -e "$BLUE Changing Tor identity...$RESETCOLOR"
        
        # Get current IP before change
        local old_ip=$(timeout 3 curl -sSL --socks5-hostname 127.0.0.1:9050 "https://api.ipify.org" 2>/dev/null)
        
        # Determine netcat command
        local nc_cmd="nc"
        command -v nc > /dev/null 2>&1 || nc_cmd="netcat"
        
        # Method 1: Control port with cookie auth
        if [ -f /run/tor/control.authcookie ]; then
            hexcookie=$(xxd -p -c 32 /run/tor/control.authcookie)
            echo -e "AUTHENTICATE $hexcookie\nSIGNAL NEWNYM\nQUIT" | $nc_cmd 127.0.0.1 9051 &>/dev/null
        else
            # Method 2: Try without auth
            echo -e "AUTHENTICATE\nSIGNAL NEWNYM\nQUIT" | $nc_cmd 127.0.0.1 9051 &>/dev/null
        fi
        
        # Method 3: Reload service as fallback
        if [ $? -ne 0 ]; then
            systemctl reload tor 2>/dev/null || systemctl restart tor
        fi
        
        echo -e "$BLUE Waiting for new identity...$RESETCOLOR"
        sleep 5
        
        # Verify IP changed
        local new_ip=$(timeout 3 curl -sSL --socks5-hostname 127.0.0.1:9050 "https://api.ipify.org" 2>/dev/null)
        
        if [ -n "$old_ip" ] && [ -n "$new_ip" ]; then
            if [ "$old_ip" != "$new_ip" ]; then
                echo -e "$GREEN ✓ Identity changed successfully$RESETCOLOR"
                echo -e "$BLUE   Old IP: $old_ip$RESETCOLOR"
                echo -e "$GREEN   New IP: $new_ip$RESETCOLOR"
            else
                echo -e "$YELLOW ⚠ IP unchanged. Circuit may be building...$RESETCOLOR"
            fi
        else
            echo -e "$GREEN ✓ Signal sent. New circuits building...$RESETCOLOR"
        fi
    else
        echo -e " $RED*$BLUE Tor is not running$RESETCOLOR\n"
    fi
}

# Main command handling with new diagnostic functions
case "$1" in
    start)
        init
        start
    ;;
    stop)
        init
        stop
    ;;
    change)
        change
    ;;
    status)
        status_with_diagnostics
    ;;
    diagnose)
        diagnose_tor_service "manual"
    ;;
    repair)
        repair_tor_service
    ;;
    myip|ip)
        ip
    ;;
    info)
        get_tor_info
    ;;
    monitor)
        monitor_tor
    ;;
    update-nodes)
        update_exit_nodes
    ;;
    verify)
        if [ -z "$2" ]; then
            echo "Usage: cerberus verify <IP>"
            exit 1
        fi
        if verify_tor_exit "$2"; then
            echo -e "$GREEN ✓ $2 is a Tor exit node$RESETCOLOR"
        else
            echo -e "$RED ✗ $2 is NOT a Tor exit node$RESETCOLOR"
        fi
    ;;
    restart)
        $0 stop
        sleep 2
        $0 start
    ;;
    *)
        echo -e "
$RED╔═══════════════════════════════════════════════════════════════════════════════╗
$RED║                    $GREEN Cerberus v2.1.1 Enhanced                                  $RED║
$RED║                    $BLUE Engineered by 0xb0rn3 | 0xbv1                            $RED║
$RED║                    $BLUE https://github.com/0xb0rn3/cerberus                      $RED║
$RED║                    $YELLOW Advanced Tor Service Diagnostics & Repair               $RED║
$RED╚═══════════════════════════════════════════════════════════════════════════════╝$RESETCOLOR

Usage: cerberus {start|stop|restart|change|status|diagnose|repair|myip|info|monitor|update-nodes|verify}

$GREEN Core Commands:$RESETCOLOR
$GREEN start$BLUE         - Start system-wide anonymous tunneling through TOR
$GREEN stop$BLUE          - Stop anonymous tunneling and restore original settings  
$GREEN restart$BLUE       - Restart Cerberus (stop + start)
$GREEN change$BLUE        - Change TOR identity (get new exit node)
$GREEN status$BLUE        - Check Cerberus status with diagnostics
$GREEN myip$BLUE          - Show current IP address

$GREEN Network Commands:$RESETCOLOR
$GREEN info$BLUE          - Show detailed Tor network information
$GREEN monitor$BLUE       - Real-time Tor network monitoring
$GREEN update-nodes$BLUE  - Update Tor exit node database
$GREEN verify <IP>$BLUE   - Check if an IP is a Tor exit node

$GREEN Diagnostic Commands:$RESETCOLOR
$GREEN diagnose$BLUE      - Run comprehensive Tor service diagnostics
$GREEN repair$BLUE        - Attempt automatic Tor service repair

$YELLOW Enhanced Features in v2.1.1:$RESETCOLOR
$BLUE • Advanced Tor service diagnostics and repair
$BLUE • Comprehensive service health monitoring
$BLUE • Automatic detection of configuration issues
$BLUE • Enhanced logging and troubleshooting
$BLUE • Smart retry logic with auto-repair
$RESETCOLOR" >&2
        exit 1
    ;;
esac

echo -e $RESETCOLOR
exit 0
